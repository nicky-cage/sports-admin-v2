<div class="layui-row">
    <div class="layui-col-md12">
        <div class="layui-card">
            <form class="layui-form" lay-filter="" method="post" tbody="1">
                <div class="layui-form layui-card-header layuiadmin-card-header-auto">
                    <div class="layui-form-item">
                        <div class="layui-inline" style="width: 400px">
                            <label class="layui-form-label">订单时间</label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input sp-form-datetime" id="created_deposit_hrs" name="created" placeholder="请选择时间" style="width: 330px" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline" style="width: 400px">
                            <label class="layui-form-label">完成时间</label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input sp-form-datetime" id="created_deposit_hrss" name="updated" placeholder="请选择时间" style="width: 330px" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline" style="width: 400px">
                            <label class="layui-form-label">订单金额</label>
                            <div class="layui-input-inline" style="width: 100px">
                                <input autocomplete="off" class="layui-input" name="money_min" placeholder="￥" type="text"/>
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline" style="width: 100px">
                                <input autocomplete="off" class="layui-input" name="money_max" placeholder="￥" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">订单状态</label>
                            <div class="layui-input-inline">
                                <select name="status">
                                    <option value="">全部</option>
                                    <option value="2">成功</option>
                                    <option value="3">失败</option>
                                </select>
                            </div>
                        </div>
                        <br/>
                        <div class="layui-inline">
                            <label class="layui-form-label">订单号码</label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input" name="order_no" placeholder="请输入订单号" style="width: 200px" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">会员账号</label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input" name="username" placeholder="请输入会员账号" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">支付方式</label>
                            <div class="layui-input-inline">
                                <select name="channel_type">
                                    <option value="">全部</option>
                                    <option value="0">银行转账(离线)</option>
                                    <option value="1">网银</option>
                                    <option value="2">支付宝</option>
                                    <option value="3">微信</option>
                                    <option value="4">QQ钱包</option>
                                    <option value="5">快捷</option>
                                    <option value="6">京东</option>
                                    <option value="7">银联扫码</option>
                                    <option value="8">虚拟币</option>
                                    <option value="9">云闪付</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">支付渠道</label>
                            <div class="layui-input-inline">
                                <select name="account_by_name">
                                    <option value="">请选择支付渠道</option>
                                    {%for v in paymentChannels%}
                                    <option value="{{v.Code}}">{{v.Name}} - {{v.Code}}</option>
                                    {%endfor%}
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">操作人</label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input" name="finance_admin" placeholder="请输入操作人" type="text"/>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn layuiadmin-btn-list" lay-filter="sp-form-search" lay-submit>
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                            </button>
                            <button class="layui-btn sp-form-reset" type="button">重置</button>
                        </div>
                    </div>
                </div>
            </form>
            <div class="layui-card-body">
                <div style="padding-bottom: 10px">
                    {%if is_granted(PLATFORM, ADMIN.RoleId, "/user_deposit_online_hrs/export", 4) -%}
                    <button class="layui-btn sp-export-excel" data-type="export" url="/user_deposit_online_hrs/export">导出EXecl</button>
                    {%endif -%}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="layui-row">
    <div class="layui-col-md12">
        <div class="layui-card no-shadow">
            <div class="layui-card-body no-padding-lr">
                <table class="layui-table">
                    <colgroup>
                        <col width="60"/>
                        <col width="120"/>
                        <col width="100"/>
                        <col width="90"/>
                        <col width="70"/>
                        <col width="75"/>
                        <col width="75"/>
                        <col width="75"/>
                        <col width="75"/>
                        <col/>
                        <col width="125"/>
                        <col width="125"/>
                        <col width="120"/>
                        <col width="100"/>
                        <col width="100"/>
                        <col width="55"/>
                        <col width="90"/>
                    </colgroup>
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>订单编号</th>
                        <th>会员账号</th>
                        <th>会员等级</th>
                        <th>支付方式</th>
                        <th>订单金额</th>
                        <th>到账金额</th>
                        <th>上分金额</th>
                        <th>存款优惠</th>
                        <th>会员标签</th>
                        <th>订单时间</th>
                        <th>完成时间</th>
                        <th>支付渠道/编码</th>
                        <th>操作人</th>
                        <th>备注</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['form', 'laydate', 'jquery', 'form', 'element', 'layer'], function () {
        let $ = layui.$,
            form = layui.form,
            element = layui.element,
            layer = layui.layer,
            laydate = layui.laydate;

        // 得到用户信息
        let get_user_info = function (that) {
            //得到用户编号、信息
            let tr = that.parent().parent();
            let id = $('td:eq(0)', tr).text();
            let bill_no = $('td:eq(1)', tr).text();
            return {id: id, bill_no: bill_no};
        };

        // 操作失误
        $(document).off('click', '.mistake');
        $(document).on('click', '.mistake', function () {
            let that = $(this), info = get_user_info(that), uid = that.attr('uid');
            layer.open({
                type: 2,
                area: ['600px', '600px'],
                fix: false, //不固定
                maxmin: true,
                shadeClose: true,
                shade: 0.4,
                title: '离线存款-失误反转',
                content: '/user_deposit_hrs/mistake?id=' + info.id + '&uid=' + uid,
            });
        });

        // 显示日志
        $(document).off('click', '.alog');
        $(document).on('click', '.alog', function () {
            let that = $(this),
                info = get_user_info($(this)),
                uid = that.attr('uid');
            layer.open({
                type: 2,
                area: ['800px', '600px'],
                fix: false, //不固定
                maxmin: true,
                shadeClose: true,
                shade: 0.4,
                title: '日志记录',
                content: '/user_deposit_logs?bill_no=' + info.bill_no + '&uid=' + uid,
            });
        });

        // 手动补单
        $(document).off('click', '.fix-deposit');
        $(document).on('click', '.fix-deposit', function () {
            let that = $(this),
                order_no = that.attr('rid'),
                uid = that.attr('uid');
            sp.post('/user_deposit_hrs/fix?order_no=' + order_no + '&uid=' + uid, {}, function (result) {
                if (result.errcode == 0) {
                    // 如果成功
                    let status = result.data.status,
                        amount = result.data.amount,
                        discount = result.data.discount;
                    if (status != 1) {
                        return;
                    }
                    let text = '你确定要为此订单进行补单么?<br /><br />' +
                        '订单编号: ' + order_no + '<br />' +
                        "订单状态: <span class='green'>支付成功</span> (三方平台)<br />" +
                        '订单金额: ' + amount + '<br />' +
                        '优惠金额: ' + discount + '<br />' +
                        '上分总计: ' + (parseFloat(amount) + parseFloat(discount)).toFixed(2) + '<br /><br />' +
                        "<span class='red'>警告: <br />" +
                        '1.此操作将增加用户账户余额!<br />' +
                        '2.应先确认还没有为此存款手工上分!<br />' +
                        "<span style='font-weight: bold;'>请务必谨慎执行此次操作!!!</span>" +
                        '</span>';
                    sp.confirm(text, function () {
                        sp.post('/user_deposit_hrs/fix?confirm=2&order_no=' + order_no + '&uid=' + uid, {}, function (result) {
                            if (result.errcode != 0) {
                                sp.alert(result.message);
                                return;
                            }
                            sp.alertSuccess('手工补单成功', function () {
                                location.reload();
                            });
                        });
                    });
                }
            });
        });

        // 订单信息
        $(document).off('click', '.order-no');
        $(document).on('click', '.order-no', function () {
            let that = $(this),
                order_no = that.html(),
                uid = that.attr('uid');
            sp.post('/user_deposits/order_info?order_number=' + order_no + '&uid=' + uid, {order_number: order_no}, function (result) {
                if (result.errcode != 0) {
                    sp.alert(result.message);
                    return;
                }
                let order = result.data;
                let message =
                    '本地单号: ' + order.order_no + '<br />' +
                    '外部单号: ' + order.trade_number + '<br />' +
                    '订单金额: ' + order.amount.toFixed(2) + '<br />' +
                    '实付金额: ' + order.amount_paid.toFixed(2) + '<br />' +
                    '发起支付: ' + order.created + '<br />' +
                    "订单状态: <span class='" + (order.status == '成功' ? 'green' : 'red') + "'>" + order.status + '</span><br />' +
                    '最后通知: ' + order.notify_last + '<br />' + '通知次数: ' +
                    order.notify_count + '<br />';
                sp.alertSuccess(message);
            });
        });
    });
</script>
