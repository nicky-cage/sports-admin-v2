{% extends "../layouts/edit.html" %}
{% block body %}
<form class="layui-form" lay-filter="" method="post" action="/agents/insert">
    <div class="layui-form-item layui-row">
        <div class="layui-col-lg12">
            <label class="layui-form-label" style="width: 100px">会员账号</label>
            <div class="layui-input-inline">
                <input type="text" name="username" lay-verify="required" placeholder="会员账号,多个账号以英文逗号隔开" autocomplete="off" class="layui-input" style="width: 495px;" />
            </div>
        </div>
    </div>
    <div class="layui-form-item layui-row">
        <div class="layui-col-lg6">
            <label class="layui-form-label" style="width: 100px">会员密码</label>
            <div class="layui-input-inline">
                <input type="text" name="password" lay-verify="required" placeholder="输入会员密码,已是会员免填" autocomplete="off" class="layui-input" />
            </div>
        </div>
        <div class="layui-col-lg6">
            <label class="layui-form-label" style="width: 100px">密码确认</label>
            <div class="layui-input-inline">
                <input type="text" name="re_password" lay-verify="required" placeholder="确认会员密码,已是会员免填" autocomplete="off" class="layui-input"/>
            </div>
        </div>
    </div>
    <input type="hidden" name="label" value="转代" />
    <div class="layui-form-item layui-row">
        <div class="layui-col-lg12">
            <label class="layui-form-label">代理类型</label>
            <div class="layui-input-block" style="top: -8px;">
                <input type="radio" name="agent_type" value="0" title="普通代理" checked />
                <input type="radio" name="agent_type" value="1" title="官方代理" />
                <input type="radio" name="agent_type" value="3" title="招商代理" />
            </div>
        </div>
    </div>
    <div class="layui-form-item layui-row">
        <div class="layui-col-lg12">
            <label class="layui-form-label">佣金方案</label>
            <div class="layui-input-block" style="width: 40%">
                <select name="agent_commission" >
                    <option></option>
                    {%for r in rows %}
                    <option value="{{r.agent_commission}}">{{r.agent_commission}}</option>
                    {%endfor%}
                </select>
            </div>
        </div>
    </div>
   <div class="layui-layout-admin ag-sub" style="z-index: 99">
        <input type="hidden" value="{{r.Id}}" name="id" />
        <div class="layui-input-block layui-footer" style="margin-left: 0px; left: 0px">
            <button type="submit" class="layui-btn" lay-submit lay-filter="sp-save">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary sp-btn-cancel" lay-filter="cancel">取&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;消</button>
        </div>
    </div>
</form>

<button class="layui-btn plan_add" style="width: 120px; position: relative; top: -52px; left: 470px;">添加佣金方案</button>

<div id="commiss_plan" style="display: none; margin-top: -20px; padding-left: 20px; padding-right: 20px;">
    <div class="layui-form-item" style="width: 300px; position: relative; right: 40px">
        <label class="layui-form-label" style="top: 13px;">方案名称: </label>
        <div class="layui-input-inline">
            <input type="text" name="agent_commissions" placeholder="请输入方案名称" autocomplete="off"
                style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 200px; height: 30px"
            />
        </div>
    </div>
    <table class="layui-table">
        <colgroup>
            <col width="80" />
            <col width="80" />
            <col width="80" />
            <col width="80" />
            <col width="80" />
        </colgroup>
        <tr id="tb1">
            <td>佣金等级</td>
            <td>等级名称</td>
            <td>活跃会员</td>
            <td>总输赢</td>
            <td>佣金比例%</td>
        </tr>
        <tbody id="pl-to">
            <tr>
                <td>1</td>
                <td>一星代理</td>
                <td><input type="text" name="f-a" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" name="f-f" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
            <tr>
                <td>2</td>
                <td>二星代理</td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
            <tr>
                <td>3</td>
                <td>三星代理</td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
            <tr>
                <td>4</td>
                <td>四星代理</td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
            <tr>
                <td>5</td>
                <td>五星代理</td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
            <tr>
                <td>6</td>
                <td>六星代理</td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
                <td><input type="text" style="border-left-width: 0px; border-top-width: 0px; border-right-width: 0px; width: 70px; height: 30px" /></td>
            </tr>
        </tbody>
    </table>
    <p>举例说明：</p>
    <p>1、活跃会员数量：一星代理要求活跃会员数大于等于5，小于10；总输赢一星代理要求输赢大于等于1.00，小于50000.00；即大于等于1星填写的数值，小于二星填写的数值；</p>
    <p>2、后续星级的数值一定要大于前面星级，如果填写有误，保存时候，无法保存，框内红色字体提示</p>
    <p>3、如只填写1星，其他星级为空，则该方案就1个佣金比例配置</p>
    <p>4、默认为6个星级，点击下面的新增佣金等级按钮，则会增加1个新的星级；</p>
    <p>5、点击编辑/保存，则保存本方案；</p>
    <p>6、方案名必填，最大10个汉字长度</p>
    <div class="layui-layout-admin com-sub" style="margin: 0 150px">
        <div class="layui-input-block" style="margin-left: 0px; left: 0px">
            <button type="button" class="layui-btn le-ap">新增佣金等级</button>
            <button type="button" class="layui-btn layui-btn-primary co-sa">保存佣金方案</button>
        </div>
    </div>
</div>

<script>
    layui.use(['form', 'jquery', 'layer'], function () {
        let $ = layui.$, layer = layui.layer, form = layui.form;
        let i = 1;
        let arr = ['七星代理', '八星代理', '九星代理', '十星代理'];
        $('.le-ap').click(function () {
            let b = $('#pl-to tr').length;
            let html = '';
            html = html + '<tr>';
            html = html + '<td>' + (b + 1) + '</td>';
            html = html + '<td>' + arr[b - 6] + '</td>';
            html = html + "<td><input type='text' style='border-left-width:0px;border-top-width:0px;border-right-width:0px;width:70px;height:30px;'></td>";
            html = html + "<td><input type='text' style='border-left-width:0px;border-top-width:0px;border-right-width:0px;width:70px;height:30px;'></td>";
            html = html + "<td><input type='text' style='border-left-width:0px;border-top-width:0px;border-right-width:0px;width:70px;height:30px;'></td>";
            $('#pl-to').append(html);
        });

        $('.co-sa').click(function () {
            let plan = $("#agent_commission option:selected").val();
            if (plan == '' || plan.length > 10) {
                layer.open({
                    titile: '温馨提示',
                    content: '请填写正确的方案名',
                });
                return false;
            }

            let a = $("input[name='f-f']").val();
            let c = $("input[name='f-a']").val();

            if (c < 5 || c > 10) {
                layer.open({
                    titile: '温馨提示',
                    content: '一星代理要求活跃会员数大于等于5，小于10；',
                });
                return false;
            }
            if (a < 1 || a > 50000) {
                layer.open({
                    titile: '温馨提示',
                    content: '总输赢一星代理要求输赢大于等于1.00，小于50000.00；',
                });
                return false;
            }
            let b = $('#pl-to tr').length;

            let arraylist = {};
            let se = ['', 'level_id', 'level', 'active_num', 'negative_profit', 'rate'];
            for (let i = 1; i <= b; i++) {
                let arr = {};
                for (let v = 1; v <= 5; v++) {
                    if (v > 2) {
                        let a = $('#pl-to tr:nth-child(' + i + ') td:nth-child(' + v + ') input').val();
                        if (i >= 2) {
                            if (parseInt(arraylist[i - 2][se[v]]) > parseInt(a) && a != '') {
                                $('#pl-to tr:nth-child(' + i + ') td:nth-child(' + v + ')').css('border', '2px solid red');
                                layer.open({
                                    title: '温馨提示',
                                    content: '必须大于上一级的数值',
                                });
                                return false;
                            }
                        }
                        arr[se[v]] = a;
                    } else {
                        let a = $('#pl-to tr:nth-child(' + i + ') td:nth-child(' + v + ')').html();
                        arr[se[v]] = a;
                        arr['agent_commission'] = plan;
                    }
                }

                arraylist[i - 1] = arr;
            }

            $.ajax({
                url: '/agents/commissions/plan/add',
                type: 'post',
                data: JSON.stringify(arraylist),
                success: function (data) {
                    if (data.errcode == 0) {
                        layer.open({
                            titile: '温馨提示',
                            content: data.data,
                        });
                        $('#commiss_plan').css('display', 'none');
                        $('.ag-sub').css('display', 'block');
                        $('.plan_add').html('添加佣金方案');
                        form.render('select');
                    } else {
                        layer.open({
                            titile: '温馨提示',
                            content: data.data,
                        });
                    }
                },
                error: function () {
                    layer.open({
                        titile: '温馨提示',
                        content: '程序错误',
                    });
                },
            });
        });

        $('.plan_add').click(function () {
            $('#layui-layer-iframe1').height('700px');
            if (i % 2 == 0) {
                $('#commiss_plan').css('display', 'none');
                $('.ag-sub').css('display', 'block');
                $('.plan_add').html('添加佣金方案');
            } else {
                $('#commiss_plan').css('display', 'block');
                $('.ag-sub').css('display', 'none');
                $('.plan_add').html('取消添加');
            }
            i++;
        });
    });
</script>
{% endblock body %}